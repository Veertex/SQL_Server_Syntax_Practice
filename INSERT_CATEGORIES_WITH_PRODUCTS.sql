CREATE PROCEDURE INSERT_CATEGORIES_WITH_PRODUCTS(@Quantity INT)
AS
BEGIN
	BEGIN TRY
		BEGIN TRANSACTION INSERT_CATEGORIES_WITH_PRODUCTS
			PRINT 'ON COMMIT TRANSACTION'
			DECLARE @I_CATEGORY INT = @Quantity
				
			WHILE @I_CATEGORY>0 BEGIN
					
				INSERT INTO categoria_producto(nombre_categoria)
				VALUES (CONCAT('CATEGORIA #',@I_CATEGORY))
					
				DECLARE @CATEGORY_ID INT = SCOPE_IDENTITY()
				DECLARE @I_PRODUCT INT = @Quantity
					
				WHILE @I_PRODUCT>0 BEGIN
						
					INSERT INTO producto(nombre_producto, id_categoria_producto)
					VALUES (CONCAT('PRODUCTO #',@I_PRODUCT), @CATEGORY_ID )
						
					SET @I_PRODUCT-=1
				END;
				SET @I_CATEGORY-=1
			END;
		COMMIT TRANSACTION INSERT_CATEGORIES_WITH_PRODUCTS
	END TRY  
	
	BEGIN CATCH  
		PRINT 'ON ROLLBACK TRANSACTION'+ CHAR(13) + ERROR_MESSAGE()
		ROLLBACK TRANSACTION INSERT_CATEGORIES_WITH_PRODUCTS
	END CATCH 
END
GO

EXEC INSERT_CATEGORIES_WITH_PRODUCTS @Quantity=8

SELECT * FROM producto INNER JOIN categoria_producto
ON categoria_producto.id_categoria_producto = producto.id_categoria_producto
